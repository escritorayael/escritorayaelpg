<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yael Goldmann - Blog</title>
  <link rel="icon" href="IMAGES/Imagen de WhatsApp 2025-07-05 a las 16.04.10_4774b179.jpg" type="image/png">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    .container-narrow{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .card-header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px;justify-content:space-between}
    .card-body{padding:20px}
    .input, textarea{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:12px;font-size:14px}
    textarea{min-height:140px;resize:vertical}
    .btn-primary{background:#482922;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer}
    .btn-outline{background:#fff;border:1px solid #482922;color:#482922;border-radius:10px;padding:8px 12px;cursor:pointer}
    .post{padding:18px 20px;border-bottom:1px solid #f0f0f0}
    .post:last-child{border-bottom:none}
    .post-title{font-size:18px;font-weight:700;margin:0 0 6px}
    .post-meta{font-size:12px;color:#6b7280;margin-bottom:8px}
    .post-content{white-space:pre-wrap;line-height:1.6}
    .muted{color:#6b7280;font-size:13px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .chip{font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:999px}
    .danger{color:#b00020}
    .list-empty{padding:16px;text-align:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .comment{border-top:1px solid #eee;padding:12px 0}
    .comment .meta{font-size:12px;color:#6b7280;margin-bottom:6px}
    .comment .body{white-space:pre-wrap;line-height:1.5}
    .comments-wrap{background:#fcfcfc;border:1px solid #eee;border-radius:10px;padding:12px;margin-top:12px}
    .pin{display:inline-flex;align-items:center;gap:6px;font-size:12px;border:1px solid #eab308;color:#a16207;background:#fef8d8;border-radius:999px;padding:2px 8px}
    .hidden{display:none}
    .sep{height:1px;background:#eee;margin:8px 0}

    /* Language selector */
    .language-selector { position: relative; display: inline-block; margin-left: 1rem; font-size: 14px; cursor: pointer; }
    .selected-lang { display: flex; align-items: center; margin-left: 2rem !important; margin-right: -8rem !important; gap: 6px; padding: 5px 10px; background-color: transparent; color: #482922; }
    .selected-lang:hover + .language-dropdown, .language-dropdown:hover { display: block; }
    .flag-icon { width: 18px; height: auto; }
    .language-dropdown { display: none; position: absolute; top: 100%; left: 0; background-color: #fff; color: black; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 10px; z-index: 999; white-space: nowrap; min-width: 160px; }
    .language-dropdown label { display: flex; align-items: center; gap: 6px; padding: 5px; cursor: pointer; }
    .language-dropdown input { margin: 0; }
    .selected-lang:hover + .language-dropdown { display: block; animation: fadeInLang 0.0s ease 0.1s forwards; opacity: 0; pointer-events: none; }
    @keyframes fadeInLang { to { opacity: 1; pointer-events: auto; } }

    #languageOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 100; display: none; }
    .navbar, .language-selector { position: relative; z-index: 101; }

    #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; justify-content: center; align-items: center; z-index: 9999; }
    .loader-wrapper { display: flex; justify-content: center; align-items: center; }
    .loader { border: 6px solid #ccc; border-top: 6px solid #482922; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Minimal overlay for search focus */
    #searchOverlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; z-index: 90; }

    .logo-yael { margin-left: -18rem !important; text-decoration: none; color: inherit; font-weight: bold; font-size: 1.2rem; }
  </style>
</head>
<body>

<div id="loaderOverlay">
  <div class="loader-wrapper">
    <div class="loader"></div>
  </div>
</div>

<!-- Language & global loaders -->
<div id="languageOverlay"></div>
<div id="loader-overlay">
  <div class="loader-wrapper">
    <div class="loader"></div>
  </div>
</div>

<!-- NAVBAR (intacto) -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-content">
      <button id="menuToggle" class="menu-toggle">
        <span class="toggle-icon"><span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span></span>
      </button>
      <a href="index.html" class="logo-yael" data-i18n="navBrand">Yael Goldmann</a>

      <div class="amazon-searchbar">
        <form id="searchForm">
          <select class="search-category">
            <option value="all" data-i18n="searchAll">All</option>
          </select>
          <input type="text" id="searchInput" placeholder="Search..." data-i18n-placeholder="searchPlaceholder"/>
          <button type="submit"><i data-lucide="search"></i></button>
        </form>
      </div>

      <div class="language-selector" id="langSelector">
        <div class="selected-lang">
          <img src="https://flagcdn.com/us.svg" alt="EN" class="flag-icon"/>
          <span>EN</span>
          <i data-lucide="chevron-down"></i>
        </div>
        <div class="language-dropdown">
          <label><input type="radio" name="lang" value="en" checked/> English - EN</label>
          <label><input type="radio" name="lang" value="es"/> Español - ES</label>
        </div>
      </div>

      <button id="mobileSearchBtn" class="mobile-search-button"><i data-lucide="search"></i></button>

      <div class="nav-links">
        <a href="pagina-libros.html" data-i18n="navBooks">Books</a>
        <a href="about.html" data-i18n="navAbout">About</a>
        <a href="blog.html" data-i18n="navBlog">Blog</a>
        <a id="accountLink" href="login.html" class="nav-icon-button" title="My Account / Login"><i data-lucide="user"></i></a>
        <button class="cart-toggle" id="cartToggleBtn">
          <i data-lucide="shopping-cart"></i><span class="cart-count" id="cartCount">0</span>
        </button>
      </div>
    </div>
  </div>
</nav>

<div id="searchOverlay"></div>

<!-- Cart Modal -->
<div id="cartModal" class="cart-modal" aria-hidden="true">
  <div class="cart-modal-content">
    <div class="cart-header">
      <h2 data-i18n="cartTitle">Shopping Cart</h2>
      <button class="close-cart" id="closeCartBtn"><i data-lucide="x"></i></button>
    </div>
    <div class="cart-body" id="cartItems"></div>
    <div class="cart-footer">
      <div class="cart-total">
        <div class="total-row"><span data-i18n="cartSubtotal">Subtotal:</span> <span id="cartSubtotal">$0.00</span></div>
        <div class="total-row"><span data-i18n="cartTax">Tax (8.5%):</span> <span id="cartTax">$0.00</span></div>
        <div class="total-row total-final"><span data-i18n="cartTotal">Total:</span> <span id="cartTotal">$0.00</span></div>
      </div>
      <div class="cart-actions">
        <button class="btn btn-primero" id="clearCartBtn" data-i18n="cartClear">Clear Cart</button>
        <button class="btn btn-primero" id="checkoutBtn">
          <i data-lucide="credit-card"></i>
          <span data-i18n="cartCheckout">Checkout</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- (Optional) Cart Page skeleton -->
<div id="cartPage" class="cart-page" style="display: none;">
  <div class="cart-page-container">
    <div class="cart-page-header">
      <h1 data-i18n="cartYourCart">Your Shopping Cart</h1>
      <button class="btn btn-outline" id="continueShoppingBtn"><i data-lucide="arrow-left"></i> <span data-i18n="cartContinue">Continue Shopping</span></button>
    </div>
    <div class="cart-page-content">
      <div class="cart-items-section"><div id="cartPageItems"></div></div>
      <div class="cart-summary-section">
        <div class="cart-summary">
          <h3 data-i18n="cartOrderSummary">Order Summary</h3>
          <div class="summary-row"><span data-i18n="cartSubtotal">Subtotal:</span><span id="pageSubtotal">$0.00</span></div>
          <div class="summary-row"><span data-i18n="cartTax">Tax (8.5%):</span><span id="pageTax">$0.00</span></div>
          <div class="summary-row"><span data-i18n="cartShipping">Shipping:</span><span data-i18n="cartShippingFree">FREE</span></div>
          <hr>
          <div class="summary-row total"><span data-i18n="cartTotal">Total:</span><span id="pageTotal">$0.00</span></div>
          <div class="checkout-section">
            <button class="btn btn-primero btn-full" id="proceedCheckoutBtn"><i data-lucide="credit-card"></i> <span data-i18n="cartProceed">Proceed to Checkout</span></button>
            <button class="btn btn-primero btn-full" id="pageClearCartBtn" data-i18n="cartClear">Clear Cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<main class="container-narrow" style="margin-top:96px">
  <!-- Editor del CANAL (solo dueña/owners) -->
  <div class="card" id="ownerComposerCard" style="display:none">
    <div class="card-header">
      <div style="display:flex;align-items:center;gap:8px">
        <i data-lucide="megaphone"></i>
        <h2 style="margin:0" data-i18n="channelEditorTitle">Canal — Publicar anuncio</h2>
        <span class="chip" title="Solo administradores" data-i18n="channelOnlyOwners">Solo dueña</span>
      </div>
      <button class="btn-outline" id="newPostResetBtn"><i data-lucide="rotate-ccw"></i> <span data-i18n="reset">Reiniciar</span></button>
    </div>
    <div class="card-body">
      <form id="ownerPostForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div>
            <label class="muted" data-i18n="channelAuthorName">Nombre a mostrar</label>
            <input class="input" id="ownerDisplayName" maxlength="60" placeholder="Yael / Admin"/>
          </div>
          <div>
            <label class="muted" data-i18n="blogPostTitle">Título</label>
            <input class="input" id="ownerTitle" maxlength="140" placeholder="Nuevo libro, evento o anuncio" required/>
          </div>
        </div>
        <label class="muted" data-i18n="blogPostContent">Contenido</label>
        <textarea id="ownerContent" class="input" maxlength="8000" placeholder="Escribe el anuncio (máx. 8.000 caracteres)" required></textarea>
        <div class="toolbar" style="margin-top:12px">
          <label class="muted">
            <input type="checkbox" id="ownerPinned"/>
            <span data-i18n="channelPin">Fijar arriba</span>
          </label>
          <div class="actions">
            <button type="button" class="btn-outline" id="ownerPreviewBtn" data-i18n="blogPreview">Vista previa</button>
            <button type="submit" class="btn-primary" id="ownerPublishBtn" data-i18n="blogPublish">Publicar</button>
          </div>
        </div>
        <p id="ownerFormMsg" class="muted" style="margin-top:8px"></p>
      </form>
      <!-- Banner de diagnóstico para dueña -->
      <div id="ownerDebug" style="margin:12px 0 0; font-size:12px; color:#6b7280;"></div>
    </div>
  </div>

  <!-- Feed del canal -->
  <div class="card" style="margin-top:20px">
    <div class="card-header">
      <div style="display:flex;align-items:center;gap:8px">
        <i data-lucide="newspaper"></i>
        <h2 style="margin:0" data-i18n="channelFeedTitle">Canal — Anuncios oficiales</h2>
      </div>
      <span class="chip" id="postCountChip">0</span>
    </div>
    <div class="card-body" id="postsList">
      <div class="list-empty muted" data-i18n="channelEmpty">Aún no hay anuncios.</div>
    </div>
    <div class="card-body" style="border-top:1px solid #eee">
      <button class="btn-outline" id="loadMoreBtn" style="width:100%" data-i18n="blogLoadMore">Cargar más</button>
    </div>
  </div>
</main>

<script>
  // ======= CART: core API (localStorage) =======
  function getCart(){ try{ return JSON.parse(localStorage.getItem('cart'))||[] }catch{ return [] } }
  function setCart(c){ localStorage.setItem('cart', JSON.stringify(c)); updateCartUI(); }
  function addToCart(id, name, price, slug, quantity){
    const cart = getCart();
    const existing = cart.find(i=>i.id===id);
    const image = (window.libros && window.libros[slug]?.image) || 'IMAGES/placeholder.png';
    if(existing){ existing.quantity += quantity; } else { cart.push({id,name,price,slug,quantity,image}); }
    setCart(cart);
  }
  function updateQuantity(index, change){
    const cart = getCart();
    if(!cart[index]) return;
    cart[index].quantity += change;
    if(cart[index].quantity <= 0){ cart.splice(index,1); }
    setCart(cart);
  }
  function removeItem(index){ const cart = getCart(); cart.splice(index,1); setCart(cart); }
  function clearCart(){ setCart([]); }
  function updateCartUI(){
    const cart = getCart();
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const subtotalEl = document.getElementById('cartSubtotal');
    const taxEl = document.getElementById('cartTax');
    const totalEl = document.getElementById('cartTotal');
    if(cartItems){ cartItems.innerHTML=''; }
    let subtotal = 0;
    cart.forEach((item, idx)=>{
      const itemTotal = item.price * item.quantity; subtotal += itemTotal;
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:1rem;">
          <img src="${item.image}" alt="cover" style="width:40px; height:auto; border-radius:4px;">
          <div style="flex:1;">
            <strong style="font-size:.9rem;">${item.name}</strong>
            <p style="font-size:.8rem; color:#6b7280;">$${Number(item.price).toFixed(2)} <span data-i18n="cartEach">each</span></p>
          </div>
          <div style="display:flex; align-items:center; gap:.5rem;">
            <button onclick="updateQuantity(${idx},-1)" style="padding:0 8px;" aria-label="-">−</button>
            <span>${item.quantity}</span>
            <button onclick="updateQuantity(${idx},1)" style="padding:0 8px;" aria-label="+">+</button>
            <button onclick="removeItem(${idx})" style="background:none; border:none; cursor:pointer;" aria-label="Remove">
              <i data-lucide="trash-2"></i>
            </button>
          </div>
        </div>
        <hr style="margin:.75rem 0;">
      `;
      if(cartItems){ cartItems.appendChild(div); }
    });
    const tax = subtotal * 0.085; const total = subtotal + tax;
    if(subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
    if(taxEl) taxEl.textContent = `$${tax.toFixed(2)}`;
    if(totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
    if(cartCount) cartCount.textContent = cart.reduce((s,i)=>s+i.quantity,0);
    if(window.lucide){ lucide.createIcons(); }
  }
  function toggleCart(show){
    const modal = document.getElementById('cartModal');
    if(!modal) return;
    const willShow = (typeof show === 'boolean') ? show : modal.getAttribute('aria-hidden') === 'true';
    modal.style.display = willShow ? 'block' : 'none';
    modal.setAttribute('aria-hidden', willShow ? 'false' : 'true');
    if(willShow) updateCartUI();
  }
  function checkout(){ window.location.href = 'checkout.html'; }
  function showMainPage(){ document.getElementById('cartPage').style.display='none'; }
</script>

<!-- Firebase Canal + Opiniones -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, startAfter, getDocs,
    doc, updateDoc, deleteDoc, where
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- CONFIG FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyBuUHOPcSjO71G0fftwhvqQV3UMqjpJJZU",
    authDomain: "escritora-yael.firebaseapp.com",
    projectId: "escritora-yael",
    storageBucket: "escritora-yael.firebasestorage.app",
    messagingSenderId: "403131540905",
    appId: "1:403131540905:web:687084531c4e1ad74590b8",
    measurementId: "G-2QYFEYN0BG"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- DUEÑOS (autoriza editor del canal) ---
  const OWNER_UIDS = ["y1Xv9Itp5PX0mY7iNNBNMFzrQW32"];
  const OWNER_EMAILS = ["goldmannyael@gmail.com"];

  const state = { user:null, isOwner:false };

  const accountLink = document.getElementById('accountLink');
  onAuthStateChanged(auth, (user)=>{
    state.user = user || null;
    const email = user?.email?.toLowerCase?.() || "";
    const uid = user?.uid || "";
    state.isOwner = (!!uid && OWNER_UIDS.includes(uid)) || (!!email && OWNER_EMAILS.includes(email));
    document.getElementById('ownerComposerCard').style.display = state.isOwner ? 'block' : 'none';
    // Debug banner
    const dbg = document.getElementById('ownerDebug');
    if(dbg){
      dbg.innerHTML = state.isOwner
        ? `UID: <b>${uid||'-'}</b> · Email: <b>${email||'-'}</b> · isOwner: <b>${state.isOwner}</b>`
        : `No eres owner en esta sesión. UID: <b>${uid||'-'}</b> · Email: <b>${email||'-'}</b>`;
    }
    if(user){ accountLink.href='account.html'; localStorage.setItem('userLoggedIn','true'); }
    else { accountLink.href='login.html'; localStorage.removeItem('userLoggedIn'); }
  });

  async function ensureAuth(){
    if(!auth.currentUser){
      try{ await signInAnonymously(auth); }
      catch(e){ console.warn('Anon auth error', e); }
    }
  }
  await ensureAuth();

  // --- Moderación básica ---
  const banned = ["http://","https://","viagra","xxx","porn","bitcoin","casino"];
  const badwords = ["idiota","imbécil","estúpido","p***","m****","hpta","hdp"];
  function sanitize(s=""){ return s.replace(/[<>]/g, ""); }
  function hasBanned(text){ const t = text.toLowerCase(); return banned.some(b=>t.includes(b)) || badwords.some(b=>t.includes(b)); }
  function tooManyCaps(text){ const caps=(text.match(/[A-ZÁÉÍÓÚÑ]{3,}/g)||[]).length; return caps>12; }

  // --- Colecciones ---
  const POSTS_COL = 'channelPosts';     // { title, content, pinned, createdAt, authorUid, authorName, status:'published', lang }
  const COMMENTS_COL = 'channelComments'; // { postId, displayName, content, createdAt, uid, status:'approved' }

  // --- Editor del canal (owners) ---
  const ownerPostForm = document.getElementById('ownerPostForm');
  const ownerDisplayName = document.getElementById('ownerDisplayName');
  const ownerTitle = document.getElementById('ownerTitle');
  const ownerContent = document.getElementById('ownerContent');
  const ownerPinned = document.getElementById('ownerPinned');
  const ownerFormMsg = document.getElementById('ownerFormMsg');
  const ownerPreviewBtn = document.getElementById('ownerPreviewBtn');
  const ownerPublishBtn = document.getElementById('ownerPublishBtn');
  const newPostResetBtn = document.getElementById('newPostResetBtn');

  ownerPreviewBtn.addEventListener('click', ()=>{
    const title = sanitize(ownerTitle.value.trim());
    const content = sanitize(ownerContent.value.trim());
    if(!title || !content){ ownerFormMsg.textContent = window.t?.msgPreviewRequired || 'Completa título y contenido para ver la vista previa.'; return; }
    alert(`${window.t?.preview || 'Vista previa:'}\n\n${title}\n\n${content.substring(0,1200)}${content.length>1200?'…':''}`);
  });

  newPostResetBtn.addEventListener('click', ()=>{
    ownerPostForm.reset();
    ownerFormMsg.textContent = '';
    ownerPinned.checked = false;
  });

  ownerPostForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); ownerFormMsg.textContent='';
    if(!state.isOwner){ ownerFormMsg.textContent='No autorizado.'; return; }
    const title = sanitize(ownerTitle.value.trim());
    const content = sanitize(ownerContent.value.trim());
    const authorName = sanitize(ownerDisplayName.value.trim() || 'Admin');
    const pinned = !!ownerPinned.checked;

    if(!title || !content){ ownerFormMsg.textContent = window.t?.msgTitleContentRequired || 'Título y contenido son obligatorios.'; return; }
    if(content.length < 20){ ownerFormMsg.textContent = window.t?.msgTooShort || 'El contenido es muy corto. Amplíalo (mín. 20 caracteres).'; return; }
    if(hasBanned(`${title} ${content}`) || tooManyCaps(content)){
      ownerFormMsg.innerHTML = `<span class='danger'>${window.t?.msgNotAllowed || 'Tu texto parece incluir contenido no permitido.'}</span>`; return;
    }

    ownerPublishBtn.disabled = true;
    try{
      const uidNow = state.user?.uid || auth.currentUser?.uid || null;
      if(!uidNow){ throw new Error('NO_AUTH_USER'); }

      await addDoc(collection(db, POSTS_COL), {
        title, content, pinned,
        createdAt: serverTimestamp(),
        authorUid: uidNow,           // <-- requerido por reglas
        authorName,
        status: 'published',
        lang: (localStorage.getItem('lang')||'en')
      });

      ownerPostForm.reset(); ownerPinned.checked=false;
      ownerFormMsg.textContent = window.t?.msgPublished || '¡Publicado!';
      postsList.innerHTML = ''; postCountChip.textContent='0'; lastVisible=null; await loadPage(true);

    }catch(err){
      console.error('Publish error:', err);
      const code = err?.code || '';
      if(code === 'permission-denied'){
        ownerFormMsg.innerHTML = "<span class='danger'>Permiso denegado. Revisa las reglas de Firestore (isOwner) y tu sesión (UID/email correctos).</span>";
      } else if(code === 'failed-precondition'){
        ownerFormMsg.innerHTML = "<span class='danger'>Falta un índice en Firestore. Abre la consola y crea el índice sugerido.</span>";
      } else if(err.message === 'NO_AUTH_USER'){
        ownerFormMsg.innerHTML = "<span class='danger'>No hay sesión válida. Inicia sesión con tu cuenta de dueña e inténtalo de nuevo.</span>";
      } else {
        ownerFormMsg.textContent = (window.t?.msgError || 'Hubo un error al publicar.') + (code? ` (${code})` : '');
      }
    } finally {
      ownerPublishBtn.disabled=false;
    }
  });

  // --- FEED del canal + paginación ---
  const postsList = document.getElementById('postsList');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const postCountChip = document.getElementById('postCountChip');
  let pageSize=8; let lastVisible=null; let initialLoaded=false;

  function postActionsHTML(id, data){
    if(!state.isOwner) return '';
    const pinTxt = data.pinned ? (window.t?.unpin||'Desfijar') : (window.t?.pin||'Fijar');
    return `
      <div class="actions">
        <button class="btn-outline" data-action="toggle-pin" data-id="${id}" data-pinned="${!!data.pinned}">
          <i data-lucide="bookmark"></i> ${pinTxt}
        </button>
        <button class="btn-outline" data-action="delete-post" data-id="${id}">
          <i data-lucide="trash-2"></i> ${window.t?.delete||'Eliminar'}
        </button>
      </div>`;
  }

  function commentFormHTML(postId){
    return `
      <div class="sep"></div>
      <form class="comment-form" data-post="${postId}">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <input class="input" name="displayName" maxlength="60" placeholder="${window.t?.blogVisibleName||'Nombre a mostrar'}"/>
          <input class="input" name="title" maxlength="0" style="display:none"/>
        </div>
        <textarea class="input" name="content" maxlength="2000" placeholder="${window.t?.commentPlaceholder||'Escribe tu opinión (máx. 2.000 caracteres)'}" required></textarea>
        <div class="toolbar" style="margin-top:8px">
          <label class="muted" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" name="accept" required/>
            <span>${window.t?.blogAcceptRules || 'Acepto las normas de convivencia (sin insultos, spam ni enlaces sospechosos).'}</span>
          </label>
          <button class="btn-primary" type="submit"><i data-lucide="send"></i> ${window.t?.send||'Enviar'}</button>
        </div>
        <p class="muted comment-msg" style="margin-top:6px"></p>
      </form>
    `;
  }

  function commentItemHTML(cId, c){
    const dateStr = c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString() : '…';
    const delBtn = state.isOwner ? `<button class="btn-outline" data-action="delete-comment" data-id="${cId}"><i data-lucide="trash"></i> ${window.t?.delete||'Eliminar'}</button>` : '';
    return `
      <div class="comment" data-comment="${cId}">
        <div class="meta">${sanitize(c.displayName || (window.t?.guest||'Invitado/a'))} · ${dateStr}</div>
        <div class="body">${sanitize(c.content||'')}</div>
        <div class="actions" style="margin-top:6px">${delBtn}</div>
      </div>
    `;
  }

  async function loadComments(container, postId){
    container.innerHTML = `<div class="muted">${window.t?.loading||'Cargando...'}</div>`;
    const qy = query(
      collection(db, COMMENTS_COL),
      where('postId','==',postId),
      orderBy('createdAt','desc'),
      limit(50)
    );
    const snap = await getDocs(qy);
    const parts = [];
    if(snap.empty){
      parts.push(`<div class="muted">${window.t?.noComments||'Sé la primera persona en opinar.'}</div>`);
    } else {
      snap.forEach(d=>parts.push(commentItemHTML(d.id, d.data())));
    }
    parts.push(commentFormHTML(postId));
    container.innerHTML = parts.join('');
    if(window.lucide){ lucide.createIcons(); }
  }

  function appendPost(id, data){
    if(data.status && data.status!=='published') return;
    const wrap=document.createElement('div'); wrap.className='post'; wrap.dataset.postId=id;
    const dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : '…';
    const pinBadge = data.pinned ? `<span class="pin"><i data-lucide="bookmark"></i> ${window.t?.pinned||'Fijado'}</span>` : '';
    wrap.innerHTML = `
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div style="flex:1 1 auto;">
          <h3 class="post-title">${sanitize(data.title||'')}</h3>
          <div class="post-meta">${pinBadge} ${sanitize(data.authorName||'Yael')} · ${dateStr}</div>
        </div>
        <div class="actions">${postActionsHTML(id, data)}</div>
      </div>
      <div class="post-content">${sanitize(data.content||'')}</div>
      <div class="comments-wrap" id="comments-${id}">
        <button class="btn-outline load-comments-btn" data-id="${id}" style="width:100%; margin-top:8px">
          <i data-lucide="message-square"></i> ${window.t?.viewComments||'Ver opiniones y opinar'}
        </button>
      </div>
    `;
    postsList.appendChild(wrap);
    postCountChip.textContent = String(Number(postCountChip.textContent)+1);
  }

  function updateEmptyState(){
    if(!postsList.children.length){ postsList.innerHTML = `<div class="list-empty muted" data-i18n="channelEmpty">${(window.t&&window.t.channelEmpty)||'Aún no hay anuncios.'}</div>`; }
    else { const empty=postsList.querySelector('.list-empty'); if(empty) empty.remove(); }
  }

  async function loadPage(reset=false){
    if(reset){ lastVisible=null; }
    let qy = query(collection(db,POSTS_COL), orderBy('pinned','desc'), orderBy('createdAt','desc'), limit(pageSize));
    if(lastVisible){ qy = query(collection(db,POSTS_COL), orderBy('pinned','desc'), orderBy('createdAt','desc'), startAfter(lastVisible), limit(pageSize)); }
    const snap = await getDocs(qy);
    if(!snap.empty){
      lastVisible = snap.docs[snap.docs.length-1];
      for(const d of snap.docs){ appendPost(d.id, d.data()); }
      updateEmptyState();
    } else {
      loadMoreBtn.disabled = true;
    }
    if(window.lucide){ lucide.createIcons(); }
  }

  if(!initialLoaded){ initialLoaded=true; await loadPage(); }
  loadMoreBtn.addEventListener('click', ()=>loadPage());

  // Delegación de eventos para acciones
  postsList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.dataset.action;

    // Cargar comentarios
    if(btn.classList.contains('load-comments-btn')){
      const postId = btn.dataset.id;
      const container = document.getElementById(`comments-${postId}`);
      btn.remove();
      await loadComments(container, postId);
      return;
    }

    // Acciones Owner
    if(act === 'toggle-pin' && state.isOwner){
      const id = btn.dataset.id; const current = btn.dataset.pinned === 'true';
      try{
        await updateDoc(doc(db, POSTS_COL, id), { pinned: !current });
        postsList.innerHTML=''; postCountChip.textContent='0'; lastVisible=null; await loadPage(true);
      }catch(err){ console.error(err); }
      return;
    }

    if(act === 'delete-post' && state.isOwner){
      const id = btn.dataset.id;
      if(!confirm(window.t?.confirmDeletePost || '¿Eliminar este anuncio?')) return;
      try{
        await deleteDoc(doc(db, POSTS_COL, id));
        btn.closest('.post')?.remove();
      }catch(err){ console.error(err); }
      return;
    }

    if(act === 'delete-comment' && state.isOwner){
      const commentId = btn.dataset.id;
      if(!confirm(window.t?.confirmDeleteComment || '¿Eliminar esta opinión?')) return;
      try{
        await deleteDoc(doc(db, COMMENTS_COL, commentId));
        btn.closest('[data-comment]')?.remove();
      }catch(err){ console.error(err); }
      return;
    }
  });

  // Envío de opiniones (delegado)
  postsList.addEventListener('submit', async (e)=>{
    const form = e.target.closest('.comment-form');
    if(!form) return;
    e.preventDefault();
    const msg = form.querySelector('.comment-msg');
    msg.textContent = '';

    const postId = form.dataset.post;
    const displayName = sanitize((form.querySelector('[name="displayName"]').value||'').trim() || (window.t?.guest||'Invitado/a'));
    const content = sanitize((form.querySelector('[name="content"]').value||'').trim());

    if(content.length < 20){ msg.textContent = window.t?.msgTooShort || 'Tu opinión es muy corta (mín. 20 caracteres).'; return; }
    if(hasBanned(content) || tooManyCaps(content)){ msg.innerHTML = `<span class="danger">${window.t?.msgNotAllowed||'Contenido no permitido.'}</span>`; return; }

    // Rate limit por post
    const KEY = `lastComment_${postId}`;
    const last = Number(localStorage.getItem(KEY)||'0');
    const RATE_MS = 60*1000;
    if(Date.now()-last < RATE_MS){
      const wait=Math.ceil((RATE_MS-(Date.now()-last))/1000);
      msg.textContent = (window.t?.msgWait||'Espera {s}s para volver a publicar.').replace('{s}', wait);
      return;
    }

    await ensureAuth();
    try{
      await addDoc(collection(db, COMMENTS_COL), {
        postId, displayName, content,
        createdAt: serverTimestamp(),
        uid: auth.currentUser? auth.currentUser.uid:null,
        status:'approved'
      });
      form.reset(); localStorage.setItem(KEY, String(Date.now()));
      msg.textContent = window.t?.msgPublished || '¡Publicado! Gracias por participar.';
      const listWrap = form.parentElement;
      const just = document.createElement('div');
      just.innerHTML = commentItemHTML('temp-'+Date.now(), {displayName,content,createdAt:{toDate:()=>new Date()}});
      listWrap.insertBefore(just.firstElementChild, form);
      if(window.lucide){ lucide.createIcons(); }
    }catch(err){
      console.error(err);
      msg.textContent = (window.t?.msgError || 'Error al publicar.') + (err?.code? ` (${err.code})` : '');
    }
  });
</script>

<!-- i18n -->
<script>
  window.t = {};
  async function loadLanguage(lang){
    try{
      const res = await fetch('lang.json');
      const tr = await res.json();
      window.t = Object.assign({}, tr[lang]||{});
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(tr[lang] && tr[lang][key]){
          const icon = el.querySelector('i');
          if(icon){ el.innerHTML = icon.outerHTML + ' ' + tr[lang][key]; }
          else { el.textContent = tr[lang][key]; }
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if(tr[lang] && tr[lang][key]){ el.placeholder = tr[lang][key]; }
      });
      const langSpan = document.querySelector('.selected-lang span');
      const langFlag = document.querySelector('.selected-lang img');
      if(lang==='es'){ langSpan.textContent = 'ES'; langFlag.src='https://flagcdn.com/es.svg'; }
      else { langSpan.textContent = 'EN'; langFlag.src='https://flagcdn.com/us.svg'; }
      document.querySelectorAll('input[name="lang"]').forEach(inp=>{ inp.checked = (inp.value===lang); });
      localStorage.setItem('lang', lang);
    }catch(e){ console.warn('i18n error', e); }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    if(window.lucide){ lucide.createIcons(); }
    document.getElementById('cartToggleBtn').addEventListener('click', ()=> toggleCart(true));
    document.getElementById('closeCartBtn').addEventListener('click', ()=> toggleCart(false));
    document.getElementById('clearCartBtn').addEventListener('click', clearCart);
    document.getElementById('pageClearCartBtn')?.addEventListener('click', clearCart);
    document.getElementById('proceedCheckoutBtn')?.addEventListener('click', checkout);
    document.getElementById('continueShoppingBtn')?.addEventListener('click', showMainPage);
    updateCartUI();
    window.addEventListener('storage', (e)=>{ if(e.key==='cart'){ updateCartUI(); } });
    document.getElementById('searchForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = document.getElementById('searchInput').value.trim();
      if(!q) return;
      localStorage.setItem('searchQuery', q);
      localStorage.setItem('searchTime', String(Date.now()));
      window.location.href = `pagina-libros.html?query=${encodeURIComponent(q)}`;
    });
    const searchInput = document.getElementById('searchInput');
    const overlay = document.getElementById('searchOverlay');
    let overlayVisible=false;
    searchInput.addEventListener('focus', ()=>{ overlay.style.display='block'; overlayVisible=true; });
    searchInput.addEventListener('blur', ()=>{ setTimeout(()=>{ overlay.style.display='none'; overlayVisible=false; }, 150); });
    window.addEventListener('wheel', ()=>{ if(overlayVisible){ overlay.style.display='none'; overlayVisible=false; searchInput.blur(); } });
    const langSelector = document.getElementById('langSelector');
    const languageOverlay = document.getElementById('languageOverlay');
    langSelector.addEventListener('mouseenter', ()=>{ languageOverlay.style.display='block'; });
    langSelector.addEventListener('mouseleave', ()=>{ setTimeout(()=>{ if(!langSelector.matches(':hover')){ languageOverlay.style.display='none'; } }, 200); });
    languageOverlay.addEventListener('mouseenter', ()=>{ languageOverlay.style.display='block'; });
    languageOverlay.addEventListener('mouseleave', ()=>{ languageOverlay.style.display='none'; });
    const saved = localStorage.getItem('lang') || 'en';
    await loadLanguage(saved);
    document.querySelectorAll('.language-dropdown input[name="lang"]').forEach(input=>{
      input.addEventListener('change', async (e)=>{
        const v = e.target.value;
        document.getElementById('loader-overlay').style.display='flex';
        await loadLanguage(v);
        setTimeout(()=>{ document.getElementById('loader-overlay').style.display='none'; }, 400);
      });
    });
  });

  // Entry loader UX
  document.body.classList.add('loading');
  window.addEventListener('load', ()=>{
    const loader = document.getElementById('loaderOverlay');
    setTimeout(()=>{ loader.style.transition='none'; loader.style.background='rgba(255,255,255,.7)'; loader.offsetHeight; loader.style.transition='opacity .6s ease'; }, 700);
    setTimeout(()=>{ loader.style.opacity='0'; document.body.classList.remove('loading'); }, 1500);
    setTimeout(()=>{ loader.remove(); }, 1800);
  });
</script>

<script> if(window.lucide){ lucide.createIcons(); } </script>
</body>
</html>
